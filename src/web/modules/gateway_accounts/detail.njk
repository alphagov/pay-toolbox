{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "common/json.njk" import json %}
{% extends "layout/layout.njk" %}

{% set isTestData = not account.live %}

{% block main %}
  {% if account.disabled %}
    {% set accountDisabledBannerHtml %}
      <p class="govuk-notification-banner__heading">This account is disabled:</p>
      <div>{{account.disabled_reason}}</div>
    {% endset %}
    {{ govukNotificationBanner({
      html: accountDisabledBannerHtml
    }) }}
  {% endif %}
  {% if currentCredential.state  === 'CREATED' %}
    {{ govukNotificationBanner({
      text: 'This account needs to be configured with PSP credentials or onboarding needs to be completed.'
    }) }}
  {% endif %}

<span class="govuk-caption-m">{{ services.name }}</span>
<h1 class="govuk-heading-m">Gateway account details <span><strong class="govuk-tag govuk-tag--grey">{{ account.payment_provider }} {{ account.type }}</strong></span></h1>

{% if services.external_id %}
  <div>
    <a href="/services/{{ services.external_id }}" class="govuk-back-link">Associated service {{services.name}} ({{ services.id }})</a>
  </div>
{% endif %}

  {% for message in messages %}
    <div class="govuk-error-summary success-summary" role="alert">
      <h2 class="govuk-error-summary__title">{{message}}</h2>
    </div>
  {% endfor %}

<div class="govuk-summary-card">
  <div class="govuk-summary-card__title-wrapper">
    <h2 class="govuk-heading-s">Account details</h2>
  </div>
  <div class="govuk-summary-card__content">
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">ID</span></dt>
        <dd class="govuk-summary-list__value">{{ account.gateway_account_id }}</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">External ID</span></dt>
        <dd class="govuk-summary-list__value">{{ account.external_id }}</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Description</span></dt>
        <dd class="govuk-summary-list__value">
          {% if account.description %}
            {{ account.description }}
          {% else %}
            <i>(None set)</i>
          {% endif %}
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Analytics</span></dt>
        <dd class="govuk-summary-list__value">
          {% if account.analytics_id %}
            <code>{{ account.analytics_id }}</code>
          {% else %}
            <i>(None set)</i>
          {% endif %}
        </dd>
      </div>
    </dl>
  </div>
</div>

<div class="govuk-summary-card">
  <div class="govuk-summary-card__title-wrapper">
    <h2 class="govuk-heading-s">{{ account.payment_provider | capitalize }} configuration</h2>
  </div>
  <div class="govuk-summary-card__content">
    <dl class="govuk-summary-list">
      {% if currentCredential and currentCredential.state %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Credentials state</span></dt>
          <dd class="govuk-summary-list__value">{{ currentCredential.state }}</dd>
        </div>
      {% endif %}
      {% if currentCredential
        and currentCredential.credentials.one_off_customer_initiated|length
        and currentCredential.credentials.one_off_customer_initiated.merchant_code %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Worldpay merchant code</span></dt>
          <dd class="govuk-summary-list__value">{{ currentCredential.credentials.one_off_customer_initiated.merchant_code }}</dd>
        </div>
        {% elif currentCredential and currentCredential.credentials.merchant_id %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">PSP merchant ID</span></dt>
          <dd class="govuk-summary-list__value">{{ currentCredential.credentials.merchant_id }}</dd>
        </div>
      {% endif %}
      {% if currentCredential and currentCredential.credentials.stripe_account_id %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Connected Stripe account</span></dt>
          <dd class="govuk-summary-list__value">
            <a class="govuk-link govuk-link--no-visited-state" target="_blank" href="{{ stripeDashboardUri }}">
              {{ currentCredential.credentials.stripe_account_id }}
            </a>
          </dd>
        </div>
      {% endif %}
      {% if account.payment_provider === 'stripe' %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Outstanding Stripe setup tasks</span></dt>
          <dd class="govuk-summary-list__value">
            {% if outstandingStripeSetupTasks | length %}
              <ul class="govuk-list">
                {% for task in outstandingStripeSetupTasks %}
                  <li>{{ task | capitalize }}</li>
                {% endfor %}
              </ul>
            {% else %}
              (All setup tasks completed)
            {% endif %}
          </dd>
        </div>
      {% elif account.payment_provider === 'worldpay' %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Payment details sent to Worldpay</span></dt>
          <dd class="govuk-summary-list__value">
            <ul class="govuk-list">
              {% if account.send_reference_to_gateway === true %}
                <li>Reference</li>
              {% else %}
                <li>Payment description</li>
              {% endif %}
              {% if account.send_payer_email_to_gateway === true %}
                <li>Email</li>
              {% endif %}
              {% if account.send_payer_ip_address_to_gateway === true %}
                <li>IP address</li>
              {% endif %}
            </ul>
          </dd>
        </div>
        {% if is3DSFlexApplicable %}
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key"><span class="govuk-caption-m">3DS Flex</span></dt>
            <dd class="govuk-summary-list__value">{% if account.worldpay_3ds_flex %}Enabled{% else %}Disabled{% endif %}</dd>
          </div>
        {% endif %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Exemption engine</span></dt>
          <dd class="govuk-summary-list__value">
            {% if account.worldpay_3ds_flex and account.worldpay_3ds_flex.exemption_engine_enabled %}
              Enabled
            {% else %}
              Disabled
            {% endif %}
          </dd>
        </div>
      {% endif %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Switching PSP</span></dt>
        <dd class="govuk-summary-list__value">{{ 'Enabled' if account.provider_switch_enabled else 'Disabled' }}</dd>
      </div>
    </dl>
  </div>
</div>

<div class="govuk-summary-card">
  <div class="govuk-summary-card__title-wrapper">
    <h2 class="govuk-heading-s">Card settings</h2>
  </div>
  <div class="govuk-summary-card__content">
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Wallets</span></dt>
        <dd class="govuk-summary-list__value">
          {% if account.allow_apple_pay or account.allow_google_pay %}
            {% if account.allow_apple_pay %} <span><strong class="govuk-tag govuk-tag--grey">Apple Pay</strong></span>{% endif %}
            {% if account.allow_google_pay %} <span><strong class="govuk-tag govuk-tag--grey">Google Pay</strong></span>{% endif %}
          {% else %}
            (No wallets enabled)
          {% endif %}
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">MOTO</span></dt>
        <dd class="govuk-summary-list__value">
          {% if account.allow_moto or
            account.allow_authorisation_api or
            account.allow_telephone_payment_notifications
          %}
            <ul class="govuk-list">
              {% if account.allow_moto %}<li>Web MOTO payments enabled</li>{% endif %}
              {% if account.allow_authorisation_api %}<li>Authorisation API enabled</li>{% endif %}
              {% if account.allow_telephone_payment_notifications %}<li>Telephone payment notifications enabled</li>{% endif %}
            </ul>
          {% else %}
            Disabled
          {% endif %}
        </dd>
        <dd class="govuk-summary-list__actions">
          <a class="govuk-link" href="/gateway_accounts/{{ gatewayAccountId }}/moto">Manage<span class="govuk-visually-hidden"> MOTO settings</span></a>
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Agent-initiated MOTO link</span></dt>
        <dd class="govuk-summary-list__value">
          {{ 'Enabled' if motoPaymentLinkExists and services.agent_initiated_moto_enabled else 'Disabled' }}
        </dd>
        <dd class="govuk-summary-list__actions">
          <a class="govuk-link" href="/gateway_accounts/{{ gatewayAccountId }}/agent_initiated_moto">Manage<span class="govuk-visually-hidden"> agent-initiated MOTO link</span></a>
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Recurring payments</span></dt>
        <dd class="govuk-summary-list__value">{{ 'Enabled' if account.recurring_enabled else 'Disabled' }}</dd>
        <dd class="govuk-summary-list__actions">
          <a class="govuk-link" href="/gateway_accounts/{{ gatewayAccountId }}/recurring_payments">Manage<span class="govuk-visually-hidden"> recurring payments</span></a>
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Prepaid cards</span></dt>
        <dd class="govuk-summary-list__value">{{ 'Blocked' if account.block_prepaid_cards else 'Allowed' }}</dd>
        <dd class="govuk-summary-list__actions">
          <a class="govuk-link" href="/gateway_accounts/{{ gatewayAccountId }}/block_prepaid_cards">Manage<span class="govuk-visually-hidden"> prepaid cards</span></a>
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Corporate surcharge</span></dt>
        <dd class="govuk-summary-list__value">
          {{ 'Enabled' if motoPaymentLinkExists and corporateSurchargeEnabled else 'Disabled' }}
        </dd>
        <dd class="govuk-summary-list__actions">
          <a class="govuk-link" href="/gateway_accounts/{{ gatewayAccountId }}/surcharge">Manage<span class="govuk-visually-hidden"> corporate surcharge</span></a>
        </dd>
      </div>
    </dl>
  </div>
</div>

<div class="govuk-summary-card">
  <div class="govuk-summary-card__title-wrapper">
    <h2 class="govuk-heading-s">Email settings</h2>
  </div>
  <div class="govuk-summary-card__content">
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Email collection mode</span></dt>
        <dd class="govuk-summary-list__value">{{ account.email_collection_mode }}</dd>
      </div>
      {% if account.email_notifications != undefined %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Payment confirmation email</span></dt>
          <dd class="govuk-summary-list__value">{{ 'Enabled' if (account.email_notifications.PAYMENT_CONFIRMED
            and account.email_notifications.PAYMENT_CONFIRMED.enabled) else 'Disabled' }}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Refund issued email</span></dt>
          <dd class="govuk-summary-list__value">{{ 'Enabled' if (account.email_notifications.REFUND_ISSUED
            and account.email_notifications.REFUND_ISSUED.enabled) else 'Disabled' }}</dd>
        </div>
      {% endif %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Email branding</span></dt>
        <dd class="govuk-summary-list__value">{{ 'Enabled' if account.notifySettings else 'Disabled' }}</dd>
        <dd class="govuk-summary-list__actions">
          <a class="govuk-link" href="/gateway_accounts/{{ gatewayAccountId }}/email_branding">Manage<span class="govuk-visually-hidden"> email branding</span></a>
        </dd>
      </div>
      {% if account.notifySettings %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Notify service ID</span></dt>
              <dd class="govuk-summary-list__value">
                {% if account.notifySettings.service_id %}
                  <a class="govuk-link govuk-link--no-visited-state" href="https://www.notifications.service.gov.uk/services/{{ account.notifySettings.service_id }}">{{ account.notifySettings.service_id }}</a>
                {% else %}
                  (Not set)
                {% endif %}</dd>
              <dd class="govuk-summary-list__actions">
                <a class="govuk-link govuk-link--no-visited-state" href="/gateway_accounts/{{ gatewayAccountId }}/email_branding">Change<span class="govuk-visually-hidden"> Notify service ID</span></a>
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Payment template ID</span></dt>
              <dd class="govuk-summary-list__value">{{ account.notifySettings.template_id }}</dd>
              <dd class="govuk-summary-list__actions">
                <a class="govuk-link govuk-link--no-visited-state" href="/gateway_accounts/{{ gatewayAccountId }}/email_branding">Change<span class="govuk-visually-hidden"> Payment template ID</span></a>
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Refund template ID</span></dt>
              <dd class="govuk-summary-list__value">{{ account.notifySettings.refund_issued_template_id }}</dd>
              <dd class="govuk-summary-list__actions">
                <a class="govuk-link govuk-link--no-visited-state" href="/gateway_accounts/{{ gatewayAccountId }}/email_branding">Change<span class="govuk-visually-hidden"> Refund template ID</span></a>
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Reply-to email address ID</span></dt>
              <dd class="govuk-summary-list__value">{{ account.notifySettings.email_reply_to_id or "(Default for Notify service)" }}</dd>
              <dd class="govuk-summary-list__actions">
                <a class="govuk-link govuk-link--no-visited-state" href="/gateway_accounts/{{ gatewayAccountId }}/email_branding">Change<span class="govuk-visually-hidden"> Reply-to email address ID</span></a>
              </dd>
            </div>
      {% endif %}
    </dl>
  </div>
</div>

  <div>
    {{ govukButton({
    text: "Manage API keys",
    href: "/gateway_accounts/" + gatewayAccountId + "/api_keys"
    })
    }}

    {# @TODO(sfount) use standard enum for provider type #}
    {% if account.payment_provider == 'stripe' %}
      {{ govukButton({
        text: "View Payouts",
        href: "/payouts?account=" + gatewayAccountId
      })
      }}
      {{ govukButton({
        text: "Update statement descriptor",
        href: "/gateway_accounts/" + gatewayAccountId + "/stripe_statement_descriptor"
      })
      }}
      {{ govukButton({
        text: "Update payout descriptor",
        href: "/gateway_accounts/" + gatewayAccountId + "/stripe_payout_descriptor"
      })
      }}
    {% endif %}

    {{ govukButton({
      text: "View payments",
      href: "/transactions?account=" + gatewayAccountId
    })
    }}
    {{ govukButton({
      text: "View refunds",
      href: "/transactions?account=" + gatewayAccountId + "&type=REFUND"
    })
    }}
    {{ govukButton({
      text: "View payment links",
      href: "/gateway_accounts/" + gatewayAccountId + "/payment_links"
    })
    }}
    {{ govukButton({
      text: "View agreements",
      href: "/agreements?account=" + gatewayAccountId
    })
    }}
    {{ govukButton({
    text: "View webhooks",
    href: "/webhooks?account=" + gatewayAccountId
    })
    }}
    {{ govukButton({
    text: "Download transaction CSV reports",
    href: "/transactions/csv?account=" + gatewayAccountId
    })
    }}
    {{ govukButton({
      text: "View statistics",
      href: "/transactions/statistics?account=" + gatewayAccountId
    })
    }}
    {{ govukButton({
      text: "Switch PSP",
      href: "/gateway_accounts/" + gatewayAccountId + "/switch_psp"
    })
    }}
  </div>

  {% if account.send_payer_ip_address_to_gateway === true %}
    <div>
      <h2 class="govuk-heading-s">Sending payer IP address to gateway is enabled</h2>
      <p class="govuk-body">If enabled, the paying user's IP address is sent to the payment gateway for fraud prevention purposes. This is not implemented for Stripe accounts.</p>
      <p class="govuk-body">3D Secure must also be enabled for the IP address to be sent to the gateway.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_payer_ip_address_to_gateway">
        {{ govukButton({
          text: "Disable sending payer IP address to gateway"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.send_payer_ip_address_to_gateway === false %}
    <div>
      <h2 class="govuk-heading-s">Enable sending payer IP address to gateway</h2>
      <p class="govuk-body">If enabled, the paying user's IP address is sent to the payment gateway for fraud prevention purposes. This is not implemented for Stripe accounts.</p>
      <p class="govuk-body">3D Secure must also be enabled for the IP address to be sent to the gateway.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_payer_ip_address_to_gateway">
        {{ govukButton({
          text: "Enable sending payer IP address to gateway",
          classes: "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  <div>
    <h2 class="govuk-heading-s">
      {% if account.send_payer_email_to_gateway %}
        Sending payer email to gateway is enabled
      {% else %}
        Enable sending payer email to gateway
      {% endif %}
    </h2>

    <p class="govuk-body">If enabled, the paying user's email is sent to the payment gateway for fraud prevention purposes. This is not implemented for Stripe accounts.</p>

    {{ govukWarningText({
      text: "Ensure that the service does not have the setting enabled in Worldpay that will send emails to the payer.",
      iconFallbackText: "Warning"
    }) }}

    <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_payer_email_to_gateway">
      {% if account.send_payer_email_to_gateway %}
        {{ govukButton({
          text: "Disable sending payer email to gateway"
          })
        }}
      {% else %}
        {{ govukButton({
          text: "Enable sending payer email to gateway",
          classes: "govuk-button--warning"
          })
        }}
      {% endif %}
      <input type="hidden" name="_csrf" value="{{ csrf }}">
    </form>
  </div>

  {% if account.payment_provider === 'worldpay' %}
    {% set 3dsFlexEnabled = account.worldpay_3ds_flex %}
    {% set exemptionEngineEnabled = account.worldpay_3ds_flex and account.worldpay_3ds_flex.exemption_engine_enabled %}

    {% set exemptionEngineHeader = "Worldpay Exemption Engine is enabled" if exemptionEngineEnabled else "Worldpay Exemption Engine is disabled" %}
    {% set exemptionEngineAction = "Disable Worldpay Exemption Engine" if exemptionEngineEnabled else "Enable Worldpay Exemption Engine" %}

    <div>
      <h2 class="govuk-heading-s">{{ exemptionEngineHeader }}</h2>
      <p class="govuk-body">The Worldpay Exemption Engine can only be enabled if the service has configured Worldpay 3DS Flex. This action will be requested by the service through support.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_worldpay_exemption_engine">
        {{ govukButton({
          text: exemptionEngineAction,
          classes: "" if exemptionEngineEnabled else "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
    <div>
  {% endif %}

  {% if account.send_reference_to_gateway === true %}
    <div>
      <h2 class="govuk-heading-s">Sending reference to gateway is enabled</h2>
      <p class="govuk-body">If enabled, the payment <b>reference</b> is sent to gateway, otherwise <b>description</b> is sent to gateway. Only applicable for Worldpay accounts</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_reference_to_gateway">
        {{ govukButton({
          text: "Disable sending reference to gateway"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.send_reference_to_gateway === false %}
    <div>
      <h2 class="govuk-heading-s">Enable sending reference to gateway</h2>
      <p class="govuk-body">If enabled, the payment <b>reference</b> is sent to gateway, otherwise <b>description</b> is sent to gateway. Only applicable for Worldpay accounts</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_reference_to_gateway">
        {{ govukButton({
          text: "Enable sending reference to gateway",
          classes: "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.disabled === true %}
  <div>
    <h2 class="govuk-heading-s">Gateway account is disabled</h2>
    <p class="govuk-body">If a gateway account is disabled, new payments cannot be initiated and refunds cannot be made.</p>
    <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/enable">
      {{ govukButton({
      text: "Enable gateway account",
      classes: "govuk-button--warning"
      })
      }}
      <input type="hidden" name="_csrf" value="{{ csrf }}">
    </form>
  </div>
  {% endif %}

  {% if account.disabled === false %}
  <div>
    <h2 class="govuk-heading-s">Disable gateway account</h2>
    <p class="govuk-body">If a gateway account is disabled, new payments cannot be initiated and refunds cannot be made.</p>
    {{ govukButton({
      text: "Disable gateway account",
      href: "/gateway_accounts/" + gatewayAccountId + "/disable",
      classes: "govuk-button--warning"
    }) }}
  </div>
  {% endif %}



  {{ json("Gateway account details source", account) }}
  {{ json("Accepted cards source", acceptedCards) }}
  {{ json("Gateway account services source", services) }}
{% endblock %}
