{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "common/json.njk" import json %}
{% extends "layout/layout.njk" %}

{% set isTestData = not account.live %}

{% block main %}
  {% if currentCredential.state  === 'CREATED' %}
    {{ govukNotificationBanner({
      text: 'This account needs to be configured with PSP credentials or onboarding needs to be completed.'
    }) }}
  {% endif %}

  <span class="govuk-caption-m">{{ account.description or account.gateway_account_id }}</span>
  <h1 class="govuk-heading-m">Gateway account details</h1>

  {% if services.external_id %}
  <div>
    <a href="/services/{{ services.external_id }}" class="govuk-back-link">Associated service {{services.name}} ({{ services.id }})</a>
  </div>
  {% endif %}

  {% for message in messages %}
    <div class="govuk-error-summary success-summary" role="alert">
      <h2 class="govuk-error-summary__title">{{message}}</h2>
    </div>
  {% endfor %}

  <div>
    <h2 class="govuk-heading-s payment__header">Gateway account details</h1>
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">ID</span></dt>
        <dd class="govuk-summary-list__value">{{ account.gateway_account_id }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      {% if account.gateway_account_external_id %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Gateway account external ID</span></dt>
          <dd class="govuk-summary-list__value">{{ account.gateway_account_external_id }}</dd>
          <dd class="govuk-summary-list__actions"></dd>
        </div>
      {% endif %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Type</span></dt>
        <dd class="govuk-summary-list__value">{{ account.type | capitalize }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Description</span></dt>
        <dd class="govuk-summary-list__value">
          {% if account.description %}
          {{ account.description }}
          {% else %}
          <i>(None set)</i>
          {% endif %}
        </dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Payment method</span></dt>
          <dd class="govuk-summary-list__value">
              {% if account.payment_method %} {{ account.payment_method }}  {% else %} CARD {% endif %}
          </dd>
          <dd class="govuk-summary-list__actions"></dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Service</span></dt>
        <dd class="govuk-summary-list__value">{{ account.service_name }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Analytics</span></dt>
        <dd class="govuk-summary-list__value">
          {% if account.analytics_id %}
          <code>{{ account.analytics_id }}</code>
          {% else %}
          <i>(None set)</i>
          {% endif %}
        </dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
    </dl>
  </div>
  <div>
    <h2 class="govuk-heading-s payment__header">PSP details</h1>
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Payment provider</span></dt>
        <dd class="govuk-summary-list__value">{{ account.payment_provider | capitalize }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      {% if currentCredential and currentCredential.state %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Credentials state</span></dt>
        <dd class="govuk-summary-list__value">{{ currentCredential.state }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      {% endif %}
      {% if currentCredential and currentCredential.credentials.merchant_id %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">PSP merchant ID</span></dt>
        <dd class="govuk-summary-list__value">{{ currentCredential.credentials.merchant_id }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      {% endif %}
      {% if currentCredential and currentCredential.credentials.stripe_account_id %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Connected Stripe account</span></dt>
        <dd class="govuk-summary-list__value"><a href="https://dashboard.stripe.com/connect/accounts/{{ currentCredential.credentials.stripe_account_id }}" class="govuk-link govuk-link--no-visited-state">{{ currentCredential.credentials.stripe_account_id }}</a></dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      {% endif %}
      {% if account.payment_provider === 'stripe' %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Outstanding Stripe setup tasks</span></dt>
        <dd class="govuk-summary-list__value">
          {% if outstandingStripeSetupTasks | length %}
          <ul class="govuk-list">
            {% for task in outstandingStripeSetupTasks %}
            <li>{{ task | capitalize }}</li>
            {% endfor %}
          </ul>
          {% else %}
            (All setup tasks completed)
          {% endif %}
        </dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      {% endif %}
    </dl>
  </div>
  <div>
    <h2 class="govuk-heading-s payment__header">Self-serve settings</h1>
    <dl class="govuk-summary-list">
    {% if account.requires3ds != undefined %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">3DS enabled</span></dt>
          <dd class="govuk-summary-list__value">{{ account.requires3ds | string | capitalize }}</dd>
          <dd class="govuk-summary-list__actions"></dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">3DS version</span></dt>
          <dd class="govuk-summary-list__value">{{ account.integration_version_3ds | string }}</dd>
          <dd class="govuk-summary-list__actions"></dd>
        </div>
        {% if account.payment_provider === 'worldpay' %}
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Exemption Engine</span></dt>
            <dd class="govuk-summary-list__value">{{ "Enabled" if account.worldpay_3ds_flex and account.worldpay_3ds_flex.exemption_engine_enabled else "Disabled" }}</dd>
            <dd class="govuk-summary-list__actions"></dd>
          </div>
        {% endif %}
    {% endif %}
    {% if account.allow_apple_pay != undefined %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Apple Pay enabled</span></dt>
          <dd class="govuk-summary-list__value">{{ account.allow_apple_pay | string | capitalize }}</dd>
          <dd class="govuk-summary-list__actions"></dd>
        </div>
    {% endif %}
    {% if account.allow_google_pay != undefined %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Google Pay enabled</span></dt>
          <dd class="govuk-summary-list__value">{{ account.allow_google_pay | string | capitalize }}</dd>
          <dd class="govuk-summary-list__actions"></dd>
        </div>
    {% endif %}
    {% if account.email_collection_mode != undefined %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Email collection mode</span></dt>
        <dd class="govuk-summary-list__value">{{ account.email_collection_mode }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
    {% endif %}
    {% if account.email_notifications != undefined %}
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Payment confirmation email</span></dt>
        <dd class="govuk-summary-list__value">{{ 'Enabled' if (account.email_notifications.PAYMENT_CONFIRMED
          and account.email_notifications.PAYMENT_CONFIRMED.enabled) else 'Disabled' }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Refund issued email</span></dt>
        <dd class="govuk-summary-list__value">{{ 'Enabled' if (account.email_notifications.REFUND_ISSUED
          and account.email_notifications.REFUND_ISSUED.enabled) else 'Disabled' }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
    {% endif %}
    </dl>
  </div>
  <div>
    <h2 class="govuk-heading-s payment__header">Toolbox configurable settings</h1>
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Switching PSP</span></dt>
        <dd class="govuk-summary-list__value">{{ 'Enabled' if account.provider_switch_enabled else 'Disabled' }}</dd>
        <dd class="govuk-summary-list__actions"></dd>
      </div>
      {% if account.block_prepaid_cards != undefined %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key"><span class="govuk-caption-m">Blocked prepaid cards</span></dt>
          <dd class="govuk-summary-list__value">{{ account.block_prepaid_cards | string | capitalize }}</dd>
          <dd class="govuk-summary-list__actions"></dd>
        </div>
      {% endif %}
    </dl>
  </div>

  <div>
    {{ govukButton({
    text: "Manage API keys",
    href: "/gateway_accounts/" + gatewayAccountId + "/api_keys"
    })
    }}
    {# @TODO(sfount) use standard enum for provider type #}
    {% if account.payment_provider == 'stripe' %}
    {{ govukButton({
    text: "View Payouts",
    href: "/payouts?account=" + gatewayAccountId
    })
    }}
    {{ govukButton({
    text: "Update statement descriptor",
    href: "/gateway_accounts/" + gatewayAccountId + "/stripe_statement_descriptor"
    })
    }}
    {{ govukButton({
    text: "Update payout descriptor",
    href: "/gateway_accounts/" + gatewayAccountId + "/stripe_payout_descriptor"
    })
    }}

    {% endif %}
    {% if account.payment_method !== "DIRECT_DEBIT" %}
      {{ govukButton({
        text: "View transactions",
        href: "/transactions?account=" + gatewayAccountId
      })
      }}
      {{ govukButton({
        text: "View payment links",
        href: "/gateway_accounts/" + gatewayAccountId + "/payment_links"
      })
      }}
      {{ govukButton({
      text: "Download transaction CSV reports",
      href: "/transactions/csv?account=" + gatewayAccountId
      })
      }}
      {{ govukButton({
        text: "View statistics",
        href: "/transactions/statistics?account=" + gatewayAccountId
      })
      }}
      {{ govukButton({
        text: "Update surcharge amounts",
        href: "/gateway_accounts/" + gatewayAccountId + "/surcharge"
      })
      }}
      {{ govukButton({
        text: "Edit email branding",
        href: "/gateway_accounts/" + gatewayAccountId + "/email_branding"
      })
      }}
      {{ govukButton({
        text: "Configure agent-initiated MOTO payments",
        href: "/gateway_accounts/" + gatewayAccountId + "/agent_initiated_moto"
      })
      }}
      {{ govukButton({
        text: "Switch PSP",
        href: "/gateway_accounts/" + gatewayAccountId + "/switch_psp"
      })
      }}
   {% endif %}
  </div>

  {% if account.payment_provider == 'stripe' %}
    <div>
      <h1 class="govuk-heading-s">Enable additional KYC data</h1>
      {% if account.requires_additional_kyc_data === false %}
        <p class="govuk-body">Please ensure the service has been notified of the additional KYC data requirement.</p>
        <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_requires_additional_kyc_data">
          {{ govukButton({
            text: "Enable requiring KYC data",
            classes: "govuk-button--warning"
          }) }}
          <input type="hidden" name="_csrf" value="{{ csrf }}">
        </form>
      {% endif %}
      {% if account.requires_additional_kyc_data === true %}
        {{ govukWarningText({
          text: "This account is flagged for requiring additional KYC data.",
          iconFallbackText: "Warning"
        }) }}
        <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_requires_additional_kyc_data">
          {{ govukButton({
            text: "Disable requiring KYC data"
          }) }}
          <input type="hidden" name="_csrf" value="{{ csrf }}">
        </form>
      {% endif %}
    </div>
  {% endif %}

  {% if account.allow_moto === false %}
    <div>
      <h1 class="govuk-heading-s">Enable MOTO payments</h1>
      <p class="govuk-body">Please ensure the service has passed PCI requirements before enabling MOTO payments.</p>
      <p class="govuk-body">MOTO payments allow services to create payments that bypass security. MOTO payments have no 3DS checks and billing addresses aren't required. This is inherently insecure.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_moto_payments">
        {{ govukButton({
          text: "Enable MOTO payments",
          classes: "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.allow_moto === true %}
    <div>
      <h1 class="govuk-heading-s">MOTO payments are enabled</h1>
      <p class="govuk-body">MOTO payments allow services to create payments that bypass security. MOTO payments have no 3DS checks and billing addresses aren't required. This is inherently insecure.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_moto_payments">
        {{ govukButton({
          text: "Disable MOTO payments"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.block_prepaid_cards === true %}
    <div>
      <h1 class="govuk-heading-s">Allow prepaid cards</h1>
      <p class="govuk-body">Prepaid cards are currently blocked on this service, users cannot use them to make payments.<p>
      <p class="govuk-body">Allowing prepaid cards could potentially mean that more fraudulent users can access the service.<p>
        {{ govukButton({
          text: "Allow prepaid cards",
          href: "/gateway_accounts/" + gatewayAccountId + "/block_prepaid_cards/toggle"
          })
        }}
    </div>
  {% endif %}

  {% if account.block_prepaid_cards === false %}
    <div>
      <h1 class="govuk-heading-s">Block prepaid cards</h1>
      <p class="govuk-body">Prepaid cards are allowed on this service, users can make payments using them.<p>
      <p class="govuk-body">Blocking prepaid cards will mean that some users that only have access to them will no longer be able to use the service.<p>
        {{ govukButton({
          text: "Block prepaid cards",
          classes: "govuk-button--warning",
          href: "/gateway_accounts/" + gatewayAccountId + "/block_prepaid_cards/toggle"
          })
        }}
    </div>
  {% endif %}

  {% if account.allow_telephone_payment_notifications === false %}
    <div>
      <h1 class="govuk-heading-s">Enable telephone payment notifications</h1>
      <p class="govuk-body">Allows use of the <a class="govuk-link govuk-link--no-visited-state" href="https://github.com/alphagov/pay-telephone-payments">API to store records of telephone payments</a> which were taken outside of GOV.UK Pay.</p>
      <p class="govuk-body">It should be ensured that the gateway account is only used for this purpose by the service and they have a separate service if they take payments using our payment pages.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_allow_telephone_payment_notifications">
        {{ govukButton({
          text: "Enable telephone payment notifications",
          classes: "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.allow_telephone_payment_notifications === true %}
    <div>
      <h1 class="govuk-heading-s">Telephone payment notifications are enabled</h1>
      <p class="govuk-body">Use of the <a class="govuk-link govuk-link--no-visited-state" href="https://github.com/alphagov/pay-telephone-payments">telephone payment notifications API</a> is enabled for this account. This is used to store records of telephone payments which were taken outside of GOV.UK Pay.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_allow_telephone_payment_notifications">
        {{ govukButton({
          text: "Disable telephone payment notifications"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.send_payer_ip_address_to_gateway === true %}
    <div>
      <h1 class="govuk-heading-s">Sending payer IP address to gateway is enabled</h1>
      <p class="govuk-body">If enabled, the paying user's IP address is sent to the payment gateway for fraud prevention purposes. This is not implemented for Stripe accounts.</p>
      <p class="govuk-body">3D Secure must also be enabled for the IP address to be sent to the gateway.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_payer_ip_address_to_gateway">
        {{ govukButton({
          text: "Disable sending payer IP address to gateway"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.send_payer_ip_address_to_gateway === false %}
    <div>
      <h1 class="govuk-heading-s">Enable sending payer IP address to gateway</h1>
      <p class="govuk-body">If enabled, the paying user's IP address is sent to the payment gateway for fraud prevention purposes. This is not implemented for Stripe accounts.</p>
      <p class="govuk-body">3D Secure must also be enabled for the IP address to be sent to the gateway.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_payer_ip_address_to_gateway">
        {{ govukButton({
          text: "Enable sending payer IP address to gateway",
          classes: "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  <div>
    <h1 class="govuk-heading-s">
      {% if account.send_payer_email_to_gateway %}
        Sending payer email to gateway is enabled
      {% else %}
        Enable sending payer email to gateway
      {% endif %}
    </h1>

    <p class="govuk-body">If enabled, the paying user's email is sent to the payment gateway for fraud prevention purposes. This is not implemented for Stripe accounts.</p>

    {{ govukWarningText({
      text: "Ensure that the service does not have the setting enabled in Worldpay that will send emails to the payer.",
      iconFallbackText: "Warning"
    }) }}

    <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_payer_email_to_gateway">
      {% if account.send_payer_email_to_gateway %}
        {{ govukButton({
          text: "Disable sending payer email to gateway"
          })
        }}
      {% else %}
        {{ govukButton({
          text: "Enable sending payer email to gateway",
          classes: "govuk-button--warning"
          })
        }}
      {% endif %}
      <input type="hidden" name="_csrf" value="{{ csrf }}">
    </form>
  </div>

  {% if account.payment_provider === 'worldpay' %}
    {% set 3dsFlexEnabled = account.worldpay_3ds_flex %}
    {% set exemptionEngineEnabled = account.worldpay_3ds_flex and account.worldpay_3ds_flex.exemption_engine_enabled %}

    {% set exemptionEngineHeader = "Worldpay Exemption Engine is enabled" if exemptionEngineEnabled else "Worldpay Exemption Engine is disabled" %}
    {% set exemptionEngineAction = "Disable Worldpay Exemption Engine" if exemptionEngineEnabled else "Enable Worldpay Exemption Engine" %}

    <div>
      <h1 class="govuk-heading-s">{{ exemptionEngineHeader }}</h1>
      <p class="govuk-body">The Worldpay Exemption Engine can only be enabled if the service has configured Worldpay 3DS Flex. This action will be requested by the service through support.</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_worldpay_exemption_engine">
        {{ govukButton({
          text: exemptionEngineAction,
          classes: "" if exemptionEngineEnabled else "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
    <div>
  {% endif %}

  {% if account.send_reference_to_gateway === true %}
    <div>
      <h1 class="govuk-heading-s">Sending reference to gateway is enabled</h1>
      <p class="govuk-body">If enabled, the payment <b>reference</b> is sent to gateway, otherwise <b>description</b> is sent to gateway. Only applicable for Worldpay accounts</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_reference_to_gateway">
        {{ govukButton({
          text: "Disable sending reference to gateway"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {% if account.send_reference_to_gateway === false %}
    <div>
      <h1 class="govuk-heading-s">Enable sending reference to gateway</h1>
      <p class="govuk-body">If enabled, the payment <b>reference</b> is sent to gateway, otherwise <b>description</b> is sent to gateway. Only applicable for Worldpay accounts</p>
      <form method="POST" action="/gateway_accounts/{{ gatewayAccountId }}/toggle_send_reference_to_gateway">
        {{ govukButton({
          text: "Enable sending reference to gateway",
          classes: "govuk-button--warning"
          })
        }}
        <input type="hidden" name="_csrf" value="{{ csrf }}">
      </form>
    </div>
  {% endif %}

  {{ json("Gateway account details source", account) }}
  {{ json("Accepted cards source", acceptedCards) }}
  {{ json("Gateway account services source", services) }}
{% endblock %}
